#! /bin/bash

$1=$dcip
$2=$router
$3=$realm

# Dependencies
#During the setup you will be asked for
#
#    Default Kerberos realm
#    Kerberos servers
#    Administrative server
#
#Based on our domain setup you need to enter the following data:
#
#    Default Kerberos realm: MY.DOMAIN.LOCAL
#    Kerberos servers: my.domain.local
#    Administrative server: pidc.my.domain.local

sudo apt update && sudo apt upgrade
sudo apt install samba smbclient winbind krb5-user krb5-config krb5-locales winbind libpam-winbind libnss-winbind -y

# Disable masked legacy service unites

sudo systemctl stop samba-ad-dc.service smbd.service nmbd.service winbind.service
sudo systemctl disable samba-ad-dc.service smbd.service nmbd.service winbind.service

# set static ip

sudo echo '# explicitely use eth0 and set static IPs, as well as domain specifics' >> /etc/dhcpcd.conf
sudo echo 'interface eth0' >> /etc/dhcpcd.conf
sudo echo 'static routers=$router' >> /etc/dhcpcd.conf
sudo echo 'static domain_name_servers=127.0.0.1' >> /etc/dhcpcd.conf
sudo echo 'static domain_name_servers=$router' >> /etc/dhcpcd.conf
sudo echo 'static ip_address=$dcip' >> /etc/dhcpcd.conf
sudo echo 'static domain_search=$realm' >> /etc/dhcpcd.conf

# Provision domain

#sudo samba-tool domain provision --use-rfc2307 --interactive

# Join Domain

#samba-tool domain join $realm

# SMB and KRB setup

sudo mv /etc/samba/smb.conf /etc/samba/smb.conf.backup
sudo mv /etc/krb5.conf /etc/krb5.conf.backup
sudo ln -sf /var/lib/samba/private/krb5.conf /etc/krb5.conf

# Start SAMBA AD services

sudo systemctl unmask samba-ad-dc.service
sudo systemctl start samba-ad-dc.service
sleep 10
sudo systemctl enable samba-ad-dc.service

# Configure resolv.conf

sudo echo '# Generated by resolvconf' > /etc/resolv.conf
sudo echo 'search $realm' >> /etc/resolv.conf
sudo echo 'nameserver 127.0.0.1' >> /etc/resolv.conf
sudo chattr +i /etc/resolv.conf

sudo update-rc.d samba defaults

echo "All done, please reboot your server as soon as you can with sudo reboot now"


